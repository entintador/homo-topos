<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Homo Topos: The Addiction Loop</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #1a1a1a;
            color: #e0e0e0;
            font-family: 'Courier New', Courier, monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
        }
        #canvas-container {
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
        }
        #ui-container {
            width: 600px;
            margin-top: 15px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        .control-group {
            text-align: center;
            width: 45%;
        }
        input[type=range] { width: 100%; cursor: pointer; }
        h1 { margin: 0 0 5px 0; font-size: 18px; color: #fff; }
        p { margin: 0; font-size: 12px; color: #888; }
        .status { margin-top: 10px; font-weight: bold; color: #ffcc00; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
</head>
<body>

    <div style="text-align: center; margin-bottom: 10px;">
        <h1>Simulation III: The Addiction Loop</h1>
        <p>Life flows Left &rarr; Right. Avoid the Sinkhole.</p>
        <p class="status" id="flowStatus">Status: Laminar Flow (Safe)</p>
    </div>

    <div id="canvas-container"></div>

    <div id="ui-container">
        <div class="control-group">
            <label>Dopamine Potency (Gravity)</label>
            <input type="range" id="gravitySlider" min="0" max="25" value="5">
            <p>Strength of the fixation</p>
        </div>
        <div class="control-group">
            <label>Willpower (Viscosity)</label>
            <input type="range" id="viscositySlider" min="0.01" max="0.2" step="0.01" value="0.15">
            <p>Resistance to deviation</p>
        </div>
    </div>

    <script>
        let particles = [];
        let sinkhole;
        let gravitySlider, viscositySlider, statusLabel;

        function setup() {
            let canvas = createCanvas(600, 400);
            canvas.parent('canvas-container');
            
            gravitySlider = select('#gravitySlider');
            viscositySlider = select('#viscositySlider');
            statusLabel = select('#flowStatus');

            sinkhole = createVector(width / 2, height - 100);

            // Initialize particles
            for (let i = 0; i < 400; i++) {
                particles.push(new Particle());
            }
        }

        function draw() {
            background(26, 26, 26, 50); // Trail effect

            let G = gravitySlider.value();
            let viscosity = viscositySlider.value();

            // Update Status Label logic
            if (G > 15 && viscosity < 0.05) {
                statusLabel.html("Status: TURBULENT COLLAPSE (Addiction)");
                statusLabel.style("color", "#ff3333");
            } else if (G > 10) {
                 statusLabel.html("Status: High Reynolds Number (Risk)");
                 statusLabel.style("color", "#ff9900");
            } else {
                statusLabel.html("Status: Laminar Flow (Stable)");
                statusLabel.style("color", "#00ffcc");
            }

            // Draw Sinkhole
            noStroke();
            // Pulse effect based on gravity
            let radius = map(G, 0, 25, 10, 60) + sin(frameCount * 0.1) * 5;
            fill(20, 0, 0);
            ellipse(sinkhole.x, sinkhole.y, radius * 1.5);
            fill(G * 10, 0, 0); // Redness increases with Dopamine
            ellipse(sinkhole.x, sinkhole.y, radius);

            // Update Particles
            for (let p of particles) {
                // 1. Base Flow Force (The Project of Life)
                let flow = createVector(0.5, 0); 
                p.applyForce(flow);

                // 2. Attraction to Sinkhole
                let dir = p5.Vector.sub(sinkhole, p.pos);
                let dist = dir.mag();
                dir.normalize();
                
                // Inverse square law, constrained
                dist = constrain(dist, 5, 200);
                let strength = (G * 100) / (dist * dist);
                dir.mult(strength);
                p.applyForce(dir);

                // 3. Viscosity (Willpower) - Drag Force
                // Drag is opposite to velocity: Fd = -c * v
                let drag = p.vel.copy();
                drag.mult(-1);
                drag.normalize();
                let speed = p.vel.mag();
                // Quadratic drag for better fluid feel
                drag.mult(viscosity * speed * speed); 
                p.applyForce(drag);

                // 4. Turbulence (Low Willpower = Noise)
                if (viscosity < 0.08) {
                    let noiseForce = p5.Vector.random2D();
                    noiseForce.mult(0.2); // Jitter
                    p.applyForce(noiseForce);
                }

                p.update();
                p.show(viscosity);
                p.checkEdges();
            }
        }

        class Particle {
            constructor() {
                this.reset();
            }

            reset() {
                this.pos = createVector(random(-100, 0), random(0, height/2)); // Start top-left
                this.vel = createVector(random(1, 3), random(-0.5, 0.5));
                this.acc = createVector(0, 0);
                this.trapped = false;
            }

            applyForce(force) {
                this.acc.add(force);
            }

            update() {
                if (this.trapped) return;

                this.vel.add(this.acc);
                this.pos.add(this.vel);
                this.acc.mult(0);

                // Check if sucked into sinkhole
                let d = p5.Vector.dist(this.pos, sinkhole);
                if (d < 20) {
                    this.reset(); // Respawn
                }
            }

            checkEdges() {
                // Respawn if it goes off screen right or bottom
                if (this.pos.x > width + 50 || this.pos.y > height + 50 || this.pos.y < -50) {
                    this.reset();
                }
            }

            show(viscosity) {
                strokeWeight(2);
                
                // Color based on velocity/danger
                // Safe = Cyan, Trapped = Red
                let speed = this.vel.mag();
                let r = map(speed, 0, 5, 0, 255);
                let g = map(speed, 0, 5, 255, 0);
                let b = 200;

                // If viscosity is low (Turbulent), make them jittery/white
                if (viscosity < 0.05) stroke(255, 100);
                else stroke(r, g, b, 150);

                point(this.pos.x, this.pos.y);
            }
        }
    </script>
</body>
</html>
